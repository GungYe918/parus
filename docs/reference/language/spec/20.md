## 9. actor, draft, pub/sub, commit, recast (v0)

### 9.1 목표

`actor`는 큰 공유 상태를 단일 소유 컨텍스트로 관리하기 위한 선언이다. v0에서는 런타임 모델을 단순하게 고정한다.

1. 상태 저장소는 `draft { ... }` 필드 집합이다.
2. 읽기 경로는 `def sub ...`.
3. 쓰기 경로는 `def pub ...`.
4. 상태 발행 경계는 `commit;`.
5. 관찰 스냅샷 재동기화 경계는 `recast;`.

### 9.2 선언 문법

```parus
actor Counter {
  draft {
    value: i32;
  }

  init(seed: i32) {
    draft.value = seed;
  }

  def sub get() -> i32 {
    recast;
    return draft.value;
  }

  def pub add(delta: i32) -> i32 {
    draft.value = draft.value + delta;
    commit;
    return draft.value;
  }
}
```

### 9.3 구조 규칙

1. actor 본문에는 `draft { ... }`가 정확히 1개 있어야 한다.
2. `draft` 필드 선언은 `x: T;`만 허용한다.
3. actor 본문에서 `let/set/mut/static/deinit` 선언은 금지한다.
4. lifecycle은 `init(...) { ... }` 또는 `init() = default;`만 허용한다.
5. actor 메서드는 `def sub ...` 또는 `def pub ...`만 허용한다. `def foo`는 금지한다.

### 9.4 생성/호출 규칙

1. actor 생성은 `spawn A(...)`만 허용한다.
2. `A(...)` 생성식은 class 전용이며 actor에는 금지한다.
3. actor 메서드 호출은 `a.foo(...)` dot 호출만 허용한다.
4. `Actor::foo(...)` 경로 호출은 금지한다.
5. actor lifecycle 직접 호출(`a.init(...)`, `A::init(...)`)은 금지한다.

### 9.5 commit/recast 제약

1. `commit;`은 `pub` 내부에서만 허용한다.
2. `recast;`는 `sub` 내부에서만 허용한다.
3. `pub`에는 최상위 블록 기준 `commit;`가 최소 1개 필요하다.
4. 중첩 블록 내부 commit은 위 규칙의 카운트에 포함하지 않는다.
5. `pub`에서 일반 `return`은 허용한다(단 commit 필수 규칙은 그대로 적용).

### 9.6 move/borrow 제약

1. `&&`는 루트 식별자 move만 허용한다.
2. `&&draft`, `&&draft.x`, `&&arr[i]`는 금지한다.
3. `&draft.x` 같은 borrow는 기존 capability 규칙을 따른다.

### 9.7 금지 예시

```parus
actor Counter {
  draft { value: i32; }

  init() = default;

  // 금지: mode 누락
  // def get() -> i32 { return draft.value; }

  def pub bad() -> i32 {
    // 금지: draft move-out
    // set x = &&draft;
    // 금지: path call
    // Counter::bad();
    commit;
    return 0i32;
  }
}
```

### 9.8 구현 상태(v0)

1. parser/tyck/SIR/OIR/LLVM 경로까지 `actor`, `spawn`, `commit`, `recast`가 연결된다.
2. LLVM 하향에서는 `commit/recast`를 actor marker helper call로 표현한다.
3. snapshot runtime 고도화(버전 관리/스케줄링/락 전략)는 다음 라운드 범위다.
