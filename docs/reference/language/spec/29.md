# 29. Macro System (Draft, Phase1.5)

문서 상태: `Draft`

이 문서는 Parus 매크로 시스템의 Phase1.5 구현 기준을 정리한다.  
정본 EBNF는 `docs/reference/language/spec/28.md`를 유지하며, 본 문서는 구현 정책/의미 규칙을 보강한다.

## 29.1 범위

1. 지원 문맥: `expr`, `stmt`, `item`, `type` typed group.
1. 호출 문법: `$path(...)`만 허용.
1. 선언 문법: `macro name -> { with <kind> { ... } }`.
1. `with token`은 실험 게이팅 전용이며 확장 경로는 아직 미구현이다.

## 29.2 호출/확장 규칙

1. 그룹 선택은 호출 문맥 기준(`expr/stmt/item/type`)으로 수행한다.
1. arm 선택은 선언 순서 first-match다.
1. 캡처 참조는 이름과 positional(`$0`, `$1`, ...)을 모두 허용한다.
1. variadic 캡처는 `$n...` 확장을 허용한다.
1. 확장 결과는 arm의 `OutKind` 문맥으로 재파싱한다.
1. 재파싱 실패/매칭 실패는 fallback 없이 컴파일 오류다.

## 29.3 스코프/선언 정책

1. 매크로 선언 허용 위치:
1. 최상위
1. `nest` 본문
1. 일반 블록 내 선언은 금지한다.
1. item 문맥 매크로 호출은 `$foo(...);` 형태로 세미콜론이 필요하다.
1. 이름 해석은 스코프 우선이며, 같은 스코프 전방참조를 허용한다.

## 29.4 위생성 (Phase1.5)

기본 정책은 hygienic이며, 현재 범위는 binder 중심이다.

1. 자동 gensym 대상 binder:
1. `let [mut] name`
1. `set [mut] name`
1. `def (...)` 파라미터 이름
1. `loop (name in ...)`
1. 캡처 토큰은 rename하지 않는다(call-site 의미 보존).
1. 비위생 escape는 기본 금지(향후 opt-in reserved).

## 29.5 확장 예산과 결정성

`ExpansionBudget { max_depth, max_steps, max_output_tokens }`

1. AOT 기본값: `64 / 20000 / 200000`
1. JIT(parusd) 기본값: `32 / 8000 / 80000`
1. 하드 상한:
1. `max_depth <= 256`
1. `max_steps <= 200000`
1. `max_output_tokens <= 1000000`
1. 사용자 입력은 clamp하며 경고를 출력한다.
1. 예산/재귀 규칙 위반은 결정적 오류로 종료한다.
1. 동일 입력과 동일 옵션에서 확장 결과는 결정적이어야 한다.

## 29.6 CLI/LSP 설정

`parusc`:

1. `-fmacro-max-depth=<N>`
1. `-fmacro-max-steps=<N>`
1. `-fmacro-max-output-tokens=<N>`
1. `-Xparus -macro-token-experimental`

`parusd initializationOptions`:

1. `parus.macroBudget.maxDepth`
1. `parus.macroBudget.maxSteps`
1. `parus.macroBudget.maxOutputTokens`
1. `parus.experimental.macroWithToken`

## 29.7 `with token` 현재 상태

1. 기본값 OFF.
1. 플래그 OFF에서 `with token` 선언은 진단으로 거부한다.
1. 플래그 ON에서 선언 파싱은 허용한다.
1. 확장기는 token-group arm 확장 시 `kMacroTokenUnimplemented`로 실패한다.

## 29.8 보류 항목

1. `$sizeof`는 현재 표준 매크로로 제공하지 않는다.
1. `sizeof` 계열은 빌트인 계약점/표준 라이브러리 체계 확정 후 별도 라운드에서 도입한다.
1. `proto`의 `require(...)`에서 메타 매크로/빌트인 프레디킷(`$is_plain_data(Self)` 등)은 아직 지원하지 않는다.
1. `proto require`는 v1에서 단순 bool 식(true/false/!/&&/||/괄호)만 허용한다.
